---
output:
  html_document:
    df_print: paged
  pdf_document:
    number_sections: no
params:
  analysis_dir: 'analysis'
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = FALSE, 
                      warning = FALSE,
                      message = FALSE,
                      cache.lazy = FALSE,
                      # force output to LaTeX (which forces the
                      # imposition of fig.pos) and proper figure alignment
                      fig.align = 'center',
                      fig.pos = 'H')

library(dplyr)
library(here)
library(tidyr)
library(stringr)
library(forcats)
library(readr)

library(kableExtra)
library(gridExtra)

library(ggplot2)
extrafont::loadfonts(quiet = TRUE)
library(GGally)
library(hrbrthemes)
theme_set(theme_ipsum())
library(atheylab.utils)
knitr::knit_hooks$set(inline = function(x) {
  atheylab.utils::pretty_print_inline(x, decimals = 2)
})
library(texreg)

source(here('scripts/analysis/utils.R'))

```

---
title: "Channel Classification Analysis"
---

Our current method of classifying channels by political leaning is pretty rough: let's take a look at how many we are able to catch.

```{r data_import}
indir <- 'data/derived_data'

# read in the classification
channel_classification <-  read_csv(here(indir, params$analysis_dir, 'channel_classification.csv'))

# get a list of all the channels we visited
read_csv(here(indir, params$analysis_dir, 'video_info.csv')) %>%
  filter(!is.na(channel)) %>%
  mutate(channel = tolower(channel)) -> video_info

video_info %>%
  unite(channel, channel, channel_id, sep=";") %>%
  count(channel) %>%
  separate(channel, c("channel_name", "channel_id"), sep = ";") %>%
  arrange(-n) -> video_channels

# join them together
video_channels <- full_join(video_channels, channel_classification, by = c('channel_name'='channel'))

# bring in channel information
read_csv(here(indir, params$analysis_dir, 'channel_info.csv')) %>%
  mutate(categories = sapply(categories, format_python_lists)) -> channel_info

# join channel info into the counts
class_full <- left_join(video_channels, channel_info, by = 'channel_id')

```

First a summary table: how many R/L/C/missing channels do we have?

```{r summ_tbl}
class_full %>%
  mutate(leaning = ifelse(is.na(leaning), 'unclassified', leaning)) %>%
  count(leaning) %>%
  mutate(share = n / sum(n)) -> summ_tbl

summ_tbl %>%
  mutate(share = scales::percent(share))
```

Anything but a pie chart:

```{r summ_viz}
summ_tbl %>%
  ggplot() + 
  geom_col(aes('', share, fill = leaning)) + 
  scale_fill_manual(values = c("purple", "blue", "red", "gray")) +
  ggtitle('Channel Classification Share')
```

What if we take into account the number of videos we have from each? R/L/C/missing weighted by number of videos from each channel.

```{r}
class_full %>%
  mutate(leaning = ifelse(is.na(leaning), 'unclassified', leaning)) %>%
  group_by(leaning) %>%
  summarise(n = sum(n, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(share = n / sum(n)) -> summ_tbl_alt

summ_tbl_alt %>%
  mutate(share = scales::percent(share))

```

```{r}
summ_tbl_alt %>%
  ggplot() + 
  geom_col(aes('', share, fill = leaning)) + 
  scale_fill_manual(values = c("purple", "blue", "red", "gray")) + 
  ggtitle('Channel Classification Share Weighted by Video Count')

```

Let's take a look at the characteristics of our most-visited channels. Want to know: what do the most-visited channels look like? First: what's the correspondence between visits and number of views/subscribers/videos? Regression line plotted in blue.

```{r}
class_full %>%
  select(channel_id, n, starts_with("n_")) %>%
  gather(stat, val, -channel_id, -n) %>%
  ggplot(aes(n, val)) +
  geom_point() +
  geom_smooth(method="lm") +
  facet_wrap(~stat, ncol = 2, scales = "free") + 
  scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x))) + 
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  xlab("log(Number of visits)") + 
  ylab("log(statistic)")

```

Distribution of these statistics by leaning of the channel:

```{r}
class_full %>%
  mutate(leaning = replace_na(leaning, "NA"),
         leaning = factor(leaning, levels = c("L", "C", "R", "NA"), ordered = TRUE)) %>%
  select(leaning, starts_with("n_")) %>%
  gather(stat, val, -leaning) %>%
  ggplot(aes(val, fill = leaning, color = leaning)) + 
  geom_density(alpha = 0.05) + 
  scale_x_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  facet_wrap(~stat, scales = "free", ncol = 2) +
  scale_fill_manual(values = c("blue", "purple", "red", "gray")) +
  scale_color_manual(values = c("blue", "purple", "red", "black")) +
  xlab("log(statistic)")
  
```

Look at the averages:

```{r}
class_full %>%
  mutate(leaning = replace_na(leaning, "NA"),
         leaning = factor(leaning, levels = c("L", "C", "R", "NA"), ordered = TRUE)) %>%
  select(leaning, starts_with("n_")) %>%
  gather(stat, val, -leaning) %>%
  group_by(leaning, stat) %>%
  summarise(val = mean(val, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(leaning, val, fill = leaning)) +
  geom_col() +
  scale_fill_manual(values = c("blue", "purple", "red", "gray")) +
  facet_wrap(~stat, scales = "free")

```


